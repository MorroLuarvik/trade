# 2021.01.14 Четверг
мёртвые ордера
|error id|req id|template|order id|status|
|:--|:--|:--|:--|:--|:--|
|1825 *|38247 *|6 cancel|42336|5 canceled|
|1826 *|38290 *|6 cancel|42365|5 canceled|
|1829 *|38386 *|6 cancel|42436|5 canceled|
|1830 *|38404 *|6 cancel|42448|5 canceled|
|1833 *|38433 *|6 cancel|42466|5 canceled|

```SQL
SELECT 
	re.error_id,
    re.req_id,
    re.error_message,
    r.template_id,
    rt.themplate_name,
    r.exch_id,
    e.exch_name,
    o.order_id,
    o.status_id,
    os.status_name
FROM `c_request_error` re
INNER JOIN c_requests as r ON re.req_id  = r.req_id
INNER JOIN s_exchanges AS e on r.exch_id = e.exch_id
INNER JOIN c_request_templates as rt ON r.template_id = rt.template_id
INNER JOIN t_orders as o ON r.object_id = o.order_id
INNER JOIN t_order_status as os ON o.status_id = os.status_id
WHERE re.is_closed = 0
```
```SQL
update c_requests set complete = 1 where req_id in (38643, 38679);
update c_request_error set is_closed = 1, close_ts = NOW() where error_id in (1849, 1851);
```

## Проблемы в Speculator'e
Я обязан сделать эту запись.

Обнаружил следующие моменты в работе спекулятора:  

Спекулятор перестал обновлять состояния торгов.  
Посмотрел на открытые ошибки с привязанными к ним запросами, в очереди было множество запросов на отмену ордера. Обработчик запросов обрабатывал только эти записи, на остальные ему не хватало ресурсов.

У всех ордеров была зафиксированна одна ошибка: нераспознанный ответ.
Отметил все запросы как выполненные и закрыл ошибки.

У меня ленивое распознавание ошибок запроса на отмену ордера. В большинстве случаев я просто помечаю ордер отменённым несмотря на наличие ошибки.

Результаты этой ошибки - переполнение очереди выполнения запросов и, как следствие, игнорирование существующих запросов.

Ещё возможна ситуация, что на одну ошибку наслаивается несколько запросов. Как в этом случае поступает спекулятор

Что необходимо сделать:
 - изменить алгоритм обработки очередей запросов, сперва самые старые, а уж затем по приоритету. Пусть тормозит, но не виснет.
 - страница с открытыми ошибками
 - отобразить плашку с открытыми ошибками

 Также обнаружил дублирование с созданием ордеров. Система отдаёт приказ на создание ордера, он проходит в потроха биржы, но она не может сообщить об этом и вместо валидного ответа показывает мусор от cloudflare.

 Как с этим бороться пока не представляю. По хорошему должна быть система подтверждения реквестов со сверкой реального состояния на бирже.

Поймал очередной момент с случаем наслоения ошибки. Была попытка создания ордера на продажу eth на бирже YoBit. Запрос прошёл, но пришла ошибка о JSON decoded error. В итоге, спекулятор осуществлял последующие попытки создания ордера. Он получал сообщения об ошибке "нехватка финансов", но сохранял прежнюю ошибку. Пришлось отменять созданный ордер на бирже, отвязывать ордер в боте и позволять ему создать новый ордер.

 error 1853
 req 38685
 order 42636

Итоговые суммы ботов меняются - "плывут".